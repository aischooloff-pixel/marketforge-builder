

# Итоговый план разработки TEMKA.STORE

## Обзор проекта

Telegram Mini App для продажи цифровых товаров (прокси, аккаунты, номера) с автоматической выдачей, оплатой через CryptoBot и полноценной админ-панелью.

---

## Этап 0: Безопасность (Критично)

### Задачи:
1. **Убрать автоматические админ-права в dev-режиме**
   - Файл: `src/contexts/TelegramContext.tsx`
   - Изменить роль с `['admin']` на `['user']` для dev-пользователя

2. **Перенести все админ-запросы через Edge Function**
   - Файл: `src/pages/AdminPage.tsx`
   - Заменить прямые Supabase-запросы на `supabase.functions.invoke('admin-api')`

3. **Создать хук для админ-операций**
   - Новый файл: `src/hooks/useAdmin.ts`
   - Централизованные API-вызовы с проверкой ошибок

### Результат:
- Админка недоступна без реальной роли в БД
- Все операции проходят серверную проверку

---

## Этап 1: Интеграция каталога с БД

### Задачи:
1. **Хуки для данных**
   - `src/hooks/useProducts.ts` — загрузка товаров с фильтрами
   - `src/hooks/useCategories.ts` — загрузка категорий
   - `src/hooks/useProductStock.ts` — подсчёт доступных items

2. **Обновление компонентов**
   - `ProductCatalog.tsx` — данные из БД вместо моков
   - `ProductCard.tsx` — отображение реального наличия
   - `ProductPage.tsx` — загрузка товара по ID

3. **Seed-данные**
   - SQL-миграция с тестовыми категориями и товарами

### Результат:
- Каталог показывает реальные товары из базы данных
- Отображается актуальное наличие

---

## Этап 2: Профиль и авторизация

### Задачи:
1. **Интеграция ProfilePage с TelegramContext**
   - Убрать зависимость от устаревшего UserContext
   - Показывать данные из таблицы `profiles`

2. **История заказов**
   - Хук `src/hooks/useOrders.ts`
   - Компонент списка заказов с фильтрами

3. **История транзакций**
   - Хук `src/hooks/useTransactions.ts`
   - Отображение пополнений и списаний

### Результат:
- Профиль показывает реальный баланс и историю
- Пользователь видит свои заказы

---

## Этап 3: Корзина и оплата

### Задачи:
1. **Привязка корзины к пользователю**
   - Сохранение в localStorage по `telegram_id`
   - Синхронизация при авторизации

2. **Интеграция с CryptoBot**
   - Хук `src/hooks/usePayment.ts`
   - Вызов `cryptobot-create-invoice` Edge Function
   - Создание заказа со статусом `pending`

3. **Оплата с баланса**
   - Проверка достаточности средств
   - Списание и создание транзакции

### Результат:
- Работающая оплата через CryptoBot
- Альтернативная оплата с баланса

---

## Этап 4: Автовыдача товаров

### Задачи:
1. **Логика в webhook**
   - Обновить `cryptobot-webhook/index.ts`
   - При оплате: взять свободный `product_item`
   - Пометить как проданный, записать в заказ

2. **Отображение купленного**
   - Страница/модал с выданным контентом
   - Кнопка копирования
   - Возможность повторного просмотра в профиле

3. **Проверка наличия**
   - Блокировка покупки при отсутствии items
   - Индикатор "Нет в наличии"

### Результат:
- Полный цикл: оплата → выдача → просмотр
- Автоматическая выдача без участия админа

---

## Этап 5: Расширенная админ-панель

### Задачи:
1. **Форма товара**
   - `src/components/admin/ProductFormDialog.tsx`
   - CRUD операции через admin-api

2. **Менеджер товарных позиций**
   - `src/components/admin/ProductItemsDialog.tsx`
   - Массовая загрузка (текстовое поле)
   - Просмотр: свободные / проданные

3. **Управление категориями**
   - `src/components/admin/CategoryManager.tsx`
   - Сортировка drag-and-drop

4. **Статистика с графиками**
   - `src/components/admin/StatsCharts.tsx`
   - Продажи за период, топ товаров

5. **Детали заказа**
   - `src/components/admin/OrderDetailsDialog.tsx`
   - Информация о покупателе, выданный контент

### Результат:
- Полное управление магазином через UI
- Визуальная аналитика продаж

---

## Структура новых файлов

```text
src/
├── hooks/
│   ├── useAdmin.ts          # Админ API-вызовы
│   ├── useProducts.ts       # Товары из БД
│   ├── useCategories.ts     # Категории из БД
│   ├── useProductStock.ts   # Наличие товаров
│   ├── useOrders.ts         # Заказы пользователя
│   ├── useTransactions.ts   # История транзакций
│   └── usePayment.ts        # Логика оплаты
│
├── components/admin/
│   ├── ProductFormDialog.tsx      # Форма товара
│   ├── ProductItemsDialog.tsx     # Управление items
│   ├── CategoryManager.tsx        # Категории
│   ├── StatsCharts.tsx            # Графики
│   └── OrderDetailsDialog.tsx     # Детали заказа
```

---

## Изменения в существующих файлах

| Файл | Изменения |
|------|-----------|
| `TelegramContext.tsx` | Убрать admin-роль в dev-режиме |
| `AdminPage.tsx` | Все запросы через admin-api |
| `ProductCatalog.tsx` | Данные из useProducts хука |
| `ProductPage.tsx` | Загрузка из БД по ID |
| `ProfilePage.tsx` | TelegramContext + реальные данные |
| `CartPage.tsx` | Интеграция с оплатой |
| `cryptobot-webhook/index.ts` | Логика автовыдачи |

---

## Порядок реализации

| # | Этап | Приоритет | Оценка |
|---|------|-----------|--------|
| 0 | Безопасность | Критичный | 1 сессия |
| 1 | Каталог из БД | Высокий | 1-2 сессии |
| 2 | Профиль | Высокий | 1 сессия |
| 3 | Оплата | Высокий | 1-2 сессии |
| 4 | Автовыдача | Высокий | 1 сессия |
| 5 | Админка | Средний | 2-3 сессии |

---

## Диаграмма потока

```text
┌──────────────────────────────────────────────────────────────┐
│                    ПОТОК ПОКУПКИ                             │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Telegram WebApp                                             │
│       │                                                      │
│       ▼                                                      │
│  [Авторизация] ──► telegram-auth ──► profiles таблица        │
│       │                                                      │
│       ▼                                                      │
│  [Каталог] ◄──── products + product_items (count)            │
│       │                                                      │
│       ▼                                                      │
│  [Корзина] ──► localStorage (по telegram_id)                 │
│       │                                                      │
│       ▼                                                      │
│  [Оплата] ──► cryptobot-create-invoice                       │
│       │              │                                       │
│       │              ▼                                       │
│       │         CryptoBot                                    │
│       │              │                                       │
│       │              ▼                                       │
│       │    cryptobot-webhook                                 │
│       │              │                                       │
│       ▼              ▼                                       │
│  [Заказ created] ──► status: paid                            │
│                      │                                       │
│                      ▼                                       │
│               product_items ──► sold = true                  │
│                      │                                       │
│                      ▼                                       │
│               [Автовыдача] ──► delivered_content             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## Следующий шаг

Начинаем с **Этапа 0: Безопасность** — закрываем доступ к админке, затем переходим к интеграции каталога с базой данных.

