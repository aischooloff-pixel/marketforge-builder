
# Итоговый план разработки TEMKA.STORE

## Обзор проекта

Telegram Mini App для продажи цифровых товаров (прокси, аккаунты, номера) с автоматической выдачей, оплатой через CryptoBot и полноценной админ-панелью.

---

## ✅ Этап 0: Безопасность (Выполнено)

### Выполненные задачи:
1. ✅ **Убраны автоматические админ-права в dev-режиме**
   - Файл: `src/contexts/TelegramContext.tsx`
   - Dev-пользователь теперь получает роль `['user']`

2. ✅ **Все админ-запросы через Edge Function**
   - Файл: `src/pages/AdminPage.tsx`
   - Прямые Supabase-запросы заменены на `admin-api`

3. ✅ **Создан хук для админ-операций**
   - Файл: `src/hooks/useAdmin.ts`
   - Централизованные API-вызовы с проверкой ошибок

---

## ✅ Этап 1: Интеграция каталога с БД (Выполнено)

### Выполненные задачи:
1. ✅ **Хуки для данных**
   - `src/hooks/useProducts.ts` — загрузка товаров с фильтрами
   - `src/hooks/useCategories.ts` — загрузка категорий
   - `useProductStock` — подсчёт доступных items

2. ✅ **Обновление компонентов**
   - `ProductCatalog.tsx` — данные из БД
   - `ProductCard.tsx` — отображение реального наличия
   - `ProductPage.tsx` — загрузка товара по ID
   - `Index.tsx` — популярные товары и категории из БД

3. ✅ **Seed-данные**
   - Добавлены 7 категорий
   - Добавлены 10 товаров
   - Добавлены product_items для демонстрации наличия

---

## ✅ Этап 2: Профиль и авторизация (Выполнено)

### Выполненные задачи:
1. ✅ **Интеграция ProfilePage с TelegramContext**
   - Убрана зависимость от устаревшего UserContext
   - Показываются данные из таблицы `profiles`

2. ✅ **История заказов**
   - Хук `src/hooks/useOrders.ts`
   - Отображение заказов с товарами и выданным контентом

3. ✅ **История транзакций**
   - Хук `src/hooks/useTransactions.ts`
   - Отображение пополнений и списаний с балансом

### Результат:
- Профиль показывает реальный баланс и историю из БД
- Пользователь видит свои заказы и выданные товары

---

## Этап 3: Корзина и оплата

### Задачи:
1. **Привязка корзины к пользователю**
   - Сохранение в localStorage по `telegram_id`
   - Синхронизация при авторизации

2. **Интеграция с CryptoBot**
   - Хук `src/hooks/usePayment.ts`
   - Вызов `cryptobot-create-invoice` Edge Function
   - Создание заказа со статусом `pending`

3. **Оплата с баланса**
   - Проверка достаточности средств
   - Списание и создание транзакции

### Результат:
- Работающая оплата через CryptoBot
- Альтернативная оплата с баланса

---

## Этап 4: Автовыдача товаров

### Задачи:
1. **Логика в webhook**
   - Обновить `cryptobot-webhook/index.ts`
   - При оплате: взять свободный `product_item`
   - Пометить как проданный, записать в заказ

2. **Отображение купленного**
   - Страница/модал с выданным контентом
   - Кнопка копирования
   - Возможность повторного просмотра в профиле

3. **Проверка наличия**
   - Блокировка покупки при отсутствии items
   - Индикатор "Нет в наличии"

### Результат:
- Полный цикл: оплата → выдача → просмотр
- Автоматическая выдача без участия админа

---

## Этап 5: Расширенная админ-панель

### Задачи:
1. **Форма товара**
   - `src/components/admin/ProductFormDialog.tsx`
   - CRUD операции через admin-api

2. **Менеджер товарных позиций**
   - `src/components/admin/ProductItemsDialog.tsx`
   - Массовая загрузка (текстовое поле)
   - Просмотр: свободные / проданные

3. **Управление категориями**
   - `src/components/admin/CategoryManager.tsx`
   - Сортировка drag-and-drop

4. **Статистика с графиками**
   - `src/components/admin/StatsCharts.tsx`
   - Продажи за период, топ товаров

5. **Детали заказа**
   - `src/components/admin/OrderDetailsDialog.tsx`
   - Информация о покупателе, выданный контент

### Результат:
- Полное управление магазином через UI
- Визуальная аналитика продаж

---

## Структура файлов

```text
src/
├── hooks/
│   ├── useAdmin.ts          ✅ Админ API-вызовы
│   ├── useProducts.ts       ✅ Товары из БД
│   ├── useCategories.ts     ✅ Категории из БД
│   ├── useOrders.ts         ⏳ Заказы пользователя
│   ├── useTransactions.ts   ⏳ История транзакций
│   └── usePayment.ts        ⏳ Логика оплаты
│
├── components/admin/
│   ├── ProductFormDialog.tsx      ⏳ Форма товара
│   ├── ProductItemsDialog.tsx     ⏳ Управление items
│   ├── CategoryManager.tsx        ⏳ Категории
│   ├── StatsCharts.tsx            ⏳ Графики
│   └── OrderDetailsDialog.tsx     ⏳ Детали заказа
```

---

## Порядок реализации

| # | Этап | Статус | Приоритет |
|---|------|--------|-----------|
| 0 | Безопасность | ✅ Выполнено | Критичный |
| 1 | Каталог из БД | ✅ Выполнено | Высокий |
| 2 | Профиль | ⏳ Следующий | Высокий |
| 3 | Оплата | ⏳ Ожидает | Высокий |
| 4 | Автовыдача | ⏳ Ожидает | Высокий |
| 5 | Админка | ⏳ Ожидает | Средний |

---

## Следующий шаг

Переходим к **Этапу 2: Профиль и авторизация** — интеграция профиля с реальными данными из БД.
